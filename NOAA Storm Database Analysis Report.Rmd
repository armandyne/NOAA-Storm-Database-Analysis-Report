---
title: Exploring the NOAA Storm Database
author: Arman Iskaliyev
date: 30 January 2018
output: 
  html_document:
    keep_md: true
---

------------------------------------------------------------------------

#Consequences of severe weather events in the U.S. between 1950 and 2011

------------------------------------------------------------------------

###Synopsis
___________
In this report bla bla....


###Data Processing
__________________
We obtained our [data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States which occurred in the period between 1950 and November of 2011. Information in database also including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

We first download the data from web resource and unzip it. The data is comma-separated-value (CSV) file compressed via the bzip2 (size: 47 Mb).
```{r}
zip.file.url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
data.dir <- "./data"
     
if (!file.exists(data.dir)) {
     dir.create(data.dir)
}

zip.file <- paste0(data.dir, "/", "StormData.csv.bz2")
if (!file.exists(zip.file)) {
     download.file(zip.file.url, zip.file)
}

csv.file <- paste0(data.dir, "/", "StormData.csv")
if (!file.exists(csv.file)) {
     unzip(zip.file, exdir = data.dir)
}

```

Then read the csv file:
```{r}
library(readr)
data <- read_csv(csv.file)
```

After reading we look at the structure of our data:
```{r}
library(dplyr)
glimpse(data)
```

Since we want to explore economical and public health consequences of weather events, subset our dataset using [National Weather Service Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf). We are basically interested in these variables listed below:

- *Fatalities/Injuries*. The determination of direct versus indirect causes of weather-related
fatalities or injuries is one of the most difficult aspects of Storm Data preparation.

- *Damage*. Property damage estimates should be entered as actual dollar amounts, if a
reasonably accurate estimate from an insurance company or other qualified individual is
available. Estimates should be rounded to
three significant digits, followed by an alphabetical character signifying the magnitude of the
number, i.e., 1.55B for $1,550,000,000. Alphabetical characters used to signify magnitude
include “K” for thousands, “M” for millions, and “B” for billions.

- *Crop Damage Data*. Crop damage information may be obtained from reliable sources,
such as the U.S. Department of Agriculture (USDA), the county/parish agricultural extension
agent, the state department of agriculture, crop insurance agencies, or any other reliable
authority. 

Look at possible damage multiplier values:
```{r}
table(data$PROPDMGEXP)
table(data$CROPDMGEXP)
```

Look at possible weather events:
```{r}
Event.types <- sort(unique(data$EVTYPE))
length(Event.types)

Event.types[c(1, 45:48, 237:239, 351:354)]
```
There is a lot of messy values in the `EVTYPE` variable. We should try to clean it.

First We select only needed variables:
```{r}
data <- select(data, BGN_DATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, CROPDMG, PROPDMGEXP, CROPDMGEXP)
tail(data)
```

Convert the `PROPDMGEXP, CROPDMGEXP, EVTYPE` values to upper case, exclude some meaningless event types:
```{r}
library(lubridate)
library(tidyr)

data <- separate(data, BGN_DATE, into = c("Date", "Time"), sep = "\\s+") %>% 
          mutate(Date = mdy(Date), 
                 PROPDMGEXP = toupper(PROPDMGEXP), 
                 CROPDMGEXP = toupper(CROPDMGEXP),
                 EVTYPE = toupper(EVTYPE)) %>% 
            select(-Time) %>% 
              filter(!grepl("^SUMMARY|^\\?|NONE" , EVTYPE))

head(data)
```

Clean the `EVTYPE` values:
```{r}
data$EVTYPE <- gsub("&", "AND", data$EVTYPE) 
data$EVTYPE <- gsub("\\s{2,}", " ", data$EVTYPE) 
data$EVTYPE <- gsub("\\\\", "/", data$EVTYPE) 
data$EVTYPE <- gsub("\\s+AND\\s+", "/", data$EVTYPE) 
data$EVTYPE <- gsub("^VOLCANIC ASH.*", "VOLCANIC ASH", data$EVTYPE) 
data$EVTYPE <- gsub("^TSTM W[I]*ND.*|^TSTM.?$|^T[H]?U[N]?[DE].*[S]?[T]?[OR]+M.*W[IN]*.*", "THUNDERSTORM WINDS", data$EVTYPE) 
data$EVTYPE <- gsub("^TORN[AD]?[DA]?O.*|.+TORNADO.*", "TORNADO", data$EVTYPE) 
data$EVTYPE <- gsub("^HURRICANE.*", "HURRICANE", data$EVTYPE) 
data$EVTYPE <- gsub("^HIGH WIND[S]?\\s*\\d+", "HIGH WIND", data$EVTYPE) 
data$EVTYPE <- gsub("WA[Y]?TER\\s?SPOUT[S]?", "WATERSPOUTS", data$EVTYPE) 
data$EVTYPE <- gsub("(SML)\\s?", "SMALL", data$EVTYPE)
data$EVTYPE <- gsub("UNSEASONABLY", "UNSEASONABLE", data$EVTYPE)
data$EVTYPE <- gsub("COOL", "COLD", data$EVTYPE)
data$EVTYPE <- gsub("THUNDERSTORMS", "THUNDERSTORM", data$EVTYPE)
data$EVTYPE <- gsub("W[I]?ND[S]?", "WIND", data$EVTYPE) 
data$EVTYPE <- gsub("HAIL.{1}\\d+\\W?\\d*", "HAIL", data$EVTYPE) 
data$EVTYPE <- gsub("\\W+$|-\\s+", "", data$EVTYPE) 

length(unique(data$EVTYPE))
```

Apply damage multipliers:
```{r}
data <- mutate(data, 
               PROPDMG = PROPDMG * if_else(PROPDMGEXP == "K", 10 ^ 3,
                                     if_else(PROPDMGEXP == "H", 10 ^ 2,
                                       if_else(PROPDMGEXP == "M", 10 ^ 6, 
                                         if_else(PROPDMGEXP == "B", 10 ^ 9, 1)
                                         , 1), 1), 1)) %>% 
          mutate(CROPDMG = CROPDMG * if_else(CROPDMGEXP == "K", 10 ^ 3,
                                       if_else(CROPDMGEXP == "H", 10 ^ 2,
                                         if_else(CROPDMGEXP == "M", 10 ^ 6, 
                                           if_else(CROPDMGEXP == "B", 10 ^ 9, 1)
                                           , 1), 1), 1)) %>% 
            select(-ends_with("EXP"))

data     
```

Set meaningful names for the variables:
```{r}
names(data) <- c("Date", "Event.Type", "Fatalities", "Injuries", "Property.Damage", "Crop.Damage")
```

Convert our dataset from wide to long:
```{r}
data <- gather(data, key = Harm.Type, value = Harm.Value, -Date, -Event.Type) %>% 
          mutate(Harm.Type = gsub("\\.", " ", Harm.Type)) %>%
            filter(Harm.Value > 0)
data
```

Check for NA values:
```{r}
sum(is.na(data))
```

Create new datasets for our main analysis goals, 
```{r}
Events.Cause.Health <- select(data, -Date) %>% 
                         filter(Harm.Type %in% c("Fatalities", "Injuries")) %>%
                           group_by(Event.Type, Harm.Type) %>% 
                             summarise(Harm.Value = sum(Harm.Value)) %>% 
                               arrange(Harm.Type, desc(Harm.Value))
Events.Cause.Health

Events.Cause.Economy <- select(data, -Date) %>% 
                         filter(Harm.Type %in% c("Property Damage", "Crop Damage")) %>%
                           group_by(Event.Type, Harm.Type) %>% 
                             summarise(Harm.Value = sum(Harm.Value)) %>% 
                               arrange(Harm.Type, desc(Harm.Value))
tail(Events.Cause.Economy)
```

As we see the top damage to the economy is estimated at billions of dollars. Lets reduce this values. 
```{r}
Events.Cause.Economy$Harm.Value <- round(Events.Cause.Economy$Harm.Value/10^9, 3)
Events.Cause.Economy
```

###Results
__________

Look at fatalities/injuries over time period:
```{r}
library(ggplot2)

data.by.year <- mutate(data, Date = year(Date)) %>% 
                  group_by(Date, Harm.Type) %>% 
                    summarise(Harm.Value = sum(Harm.Value)) 
     
ggplot(data = filter(data.by.year, Harm.Type %in% c("Fatalities", "Injuries")),
            aes(x = Date, y = Harm.Value)) + 
geom_line(color = "blue") + facet_grid(Harm.Type~.) + ylab("Value") + 
ggtitle("Damage to the population of the U.S caused by weather events")
```

Plot damage to the economy over time period:
```{r}
ggplot(data = filter(data.by.year, Harm.Type %in% c("Property Damage", "Crop Damage")),
       aes(x = Date, y = round(Harm.Value/10^6, 3))) + 
geom_line(color = "blue") + facet_grid(Harm.Type~.) + ylab("Value (in million dollars)") + 
ggtitle("Damage to the economy of the U.S caused by weather events")
```

###The most harmful to population health weather events:

```{r}
ggplot(data = Events.Cause.Health[]),  
       aes(x = Event.Type, y = Harm.Value)) +
     geom_bar(stat = "identity") + coord_flip() + 
     facet_grid(.~Harm.Type)


```

